<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/andybrewer/mvp/mvp.css">
<main class="app-container"></main>

<script>
  const appContainer = document.querySelector('.app-container');

  const setupLogin = () => {
    appContainer.innerHTML = `
      <h1>Enter Username: </h1>
      <input class="username" type="text" placeholder="username" />
      <button class="submit">Submit</button>
    `;

    const username = document.querySelector('.username');
    username.focus();
    const submit = document.querySelector('.submit');
    
    const submitEvent = (e) => {
      if (!username.value) {
        return;
      }

      const fetchOptions = {
        'method': 'POST',
        'credentials': 'include',
        headers: {
          'content-type': 'application/json'
        },
        body: JSON.stringify({
          username: username.value
        })
      };
      fetch('/api/session', fetchOptions)
        .then((response) => {
          return response.json()
        }).then((body) => {
          if (body.username) {
            localStorage.setItem('userjwt', body.jwt);
            render();
          }
        });
      username.value = '';
    };

    submit.addEventListener('click', submitEvent);
    username.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        submitEvent();
      }
      return;
    });
  };

  let jwtToken = localStorage.getItem('userjwt');
  const startApp = () => {
    fetch('/api/session', {
      headers: {
        'Authorization': `Bearer ${jwtToken}`
      }
    }).then((response) => {
      if (!response.ok) {
        return new Promise((resolve) => resolve([]));
      }     
      return response.json()
    }).then((body) => {
      if (!body.username) {
        return setupLogin();
      }
      return render();
    });
  };

  startApp();
</script>