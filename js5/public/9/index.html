<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/andybrewer/mvp/mvp.css">
<style>
  .chatContainer {
    display: flexbox;
    justify-content: space-evenly;
  }

  .memeText {
    margin-top: 20px;
  }

  .hidden {
    display: none;
  }
</style>

<main class="app-container"></main>
<script>
  const appContainer = document.querySelector('.app-container');
  let jwtToken = localStorage.getItem('userjwt');

  const render = () => {
    appContainer.innerHTML = `
      <h1>Welcome to MemeChat!</h1>
      <hr>
      <div class="chatContainer"></div>
      <hr>
      <h2>Create New Meme</h2>
      <video class="videoSrc" width=640 height=480></video>
      <input class="memeText" type="text" />
      <button class="submitButton hidden">Update Chat</button>
      <canvas class="canvas hidden" width=640 height=480></canvas>
    `;

    const videoSrc = document.querySelector('.videoSrc');
    const memeText = document.querySelector('.memeText');
    const submitButton = document.querySelector('.submitButton');
    const chatContainer = document.querySelector('.chatContainer');
    const canvas = document.querySelector('.canvas');
    const context = canvas.getContext('2d');    

    memeText.focus();

    navigator.mediaDevices.getUserMedia({
      video: true,
      audio: false
    }).then((stream) => {
      videoSrc.srcObject = stream;
      videoSrc.play();
      submitButton.classList.remove('hidden');
    });

    const handleSubmit = () => {
      context.drawImage(videoSrc, 0, 0);
      const imageData = canvas.toDataURL();
      const b64Data = imageData.replace(/^data:image\/png;base64,/, "");

      const fetchOptions = {
        method: 'POST',
        credentials: 'include',
        headers: {
          'content-type': 'application/json',
          'authorization': `Bearer ${jwtToken}`
        },
        body: JSON.stringify({
          text: memeText.valuej,
          b64Data: b64Data
        })
      };
      fetch('/api/meme', fetchOptions);
      
      memeText.value = '';
    };

    memeText.addEventListener('keyup', (e) => {
      if (e.key === 'Enter' && memeText.value) {
        return handleSubmit();
      }
      return;
    });

    submitButton.addEventListener('click', () => {
      if (memeText.value) {
        return handleSubmit();
      }
      return;
    });
  };

  const setupLogin = () => {
    appContainer.innerHTML = `
      <h1>Enter Username: </h1>
      <input class="username" type="text" placeholder="username" />
      <button class="submit">Submit</button>
    `;

    const username = document.querySelector('.username');
    username.focus();
    const submit = document.querySelector('.submit');
    
    const submitEvent = (e) => {
      if (!username.value) {
        return;
      }

      const fetchOptions = {
        'method': 'POST',
        'credentials': 'include',
        headers: {
          'content-type': 'application/json'
        },
        body: JSON.stringify({
          username: username.value
        })
      };
      fetch('/api/session', fetchOptions)
        .then((response) => {
          return response.json()
        }).then((body) => {
          if (body.username) {
            localStorage.setItem('userjwt', body.jwt);
            render();
          }
        });
      username.value = '';
    };

    submit.addEventListener('click', submitEvent);
    username.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        submitEvent();
      }
      return;
    });
  };
  
  const startApp = () => {
    fetch('/api/session', {
      headers: {
        'Authorization': `Bearer ${jwtToken}`
      }
    }).then((response) => {
      if (!response.ok) {
        return new Promise((resolve) => resolve({}));
      }     
      return response.json()
    }).then((body) => {
      if (!body.username) {
        return setupLogin();
      }
      return render();
    });
  };

  startApp();
</script>